<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Policy Manager | JSON Policy</title>
    <meta name="generator" content="VuePress 1.6.0">
    
    <meta name="description" content="JSON Policy - Distributed Rule Engine">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="preload" href="/assets/css/0.styles.8968334b.css" as="style"><link rel="preload" href="/assets/js/app.c4123b23.js" as="script"><link rel="preload" href="/assets/js/2.d3ea8322.js" as="script"><link rel="preload" href="/assets/js/16.bf02c3a1.js" as="script"><link rel="prefetch" href="/assets/js/10.5ee64c80.js"><link rel="prefetch" href="/assets/js/11.b3a8b447.js"><link rel="prefetch" href="/assets/js/12.29061add.js"><link rel="prefetch" href="/assets/js/13.607e3aa6.js"><link rel="prefetch" href="/assets/js/14.8f8bcae9.js"><link rel="prefetch" href="/assets/js/15.e4a83481.js"><link rel="prefetch" href="/assets/js/17.5c717817.js"><link rel="prefetch" href="/assets/js/3.7c13d29b.js"><link rel="prefetch" href="/assets/js/4.b41e69dd.js"><link rel="prefetch" href="/assets/js/5.5bc5eaa4.js"><link rel="prefetch" href="/assets/js/6.e416f727.js"><link rel="prefetch" href="/assets/js/7.980d9cb6.js"><link rel="prefetch" href="/assets/js/8.39ee49f0.js"><link rel="prefetch" href="/assets/js/9.aba5de70.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8968334b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/img/logo.svg" alt="JSON Policy" class="logo"> <span class="site-name can-hide">JSON Policy</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Libraries" class="dropdown-title"><span class="title">Libraries</span> <span class="arrow down"></span></button> <button type="button" aria-label="Libraries" class="mobile-dropdown-title"><span class="title">Libraries</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/php-library/" class="nav-link router-link-active">
  PHP
</a></li><li class="dropdown-item"><!----> <a href="/js-library/" class="nav-link">
  JavaScript
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Libraries" class="dropdown-title"><span class="title">Libraries</span> <span class="arrow down"></span></button> <button type="button" aria-label="Libraries" class="mobile-dropdown-title"><span class="title">Libraries</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/php-library/" class="nav-link router-link-active">
  PHP
</a></li><li class="dropdown-item"><!----> <a href="/js-library/" class="nav-link">
  JavaScript
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>PHP Library Reference</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/php-library/" aria-current="page" class="sidebar-link">Introduction</a></li><li><a href="/php-library/policy-manager.html" aria-current="page" class="active sidebar-link">Policy Manager</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/php-library/policy-manager.html#is" class="sidebar-link">-&gt;is...()</a></li><li class="sidebar-sub-header"><a href="/php-library/policy-manager.html#getparam" class="sidebar-link">-&gt;getParam()</a></li><li class="sidebar-sub-header"><a href="/php-library/policy-manager.html#bootstrap" class="sidebar-link">::bootstrap()</a></li><li class="sidebar-sub-header"><a href="/php-library/policy-manager.html#context" class="sidebar-link">context</a></li><li class="sidebar-sub-header"><a href="/php-library/policy-manager.html#custom-markers" class="sidebar-link">custom_markers</a></li><li class="sidebar-sub-header"><a href="/php-library/policy-manager.html#custom-types" class="sidebar-link">custom_types</a></li><li class="sidebar-sub-header"><a href="/php-library/policy-manager.html#custom-conditions" class="sidebar-link">custom_conditions</a></li><li class="sidebar-sub-header"><a href="/php-library/policy-manager.html#custom-resources" class="sidebar-link">custom_resources</a></li><li class="sidebar-sub-header"><a href="/php-library/policy-manager.html#custom-effects" class="sidebar-link">custom_effects</a></li><li class="sidebar-sub-header"><a href="/php-library/policy-manager.html#policies" class="sidebar-link">policies</a></li></ul></li><li><a href="/php-library/policy-marker.html" class="sidebar-link">Policy Markers</a></li><li><a href="/php-library/examples.html" class="sidebar-link">Examples</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="policy-manager"><a href="#policy-manager" class="header-anchor">#</a> Policy Manager</h1> <p>While nothing stops you from using other components of the framework directly, the policy manager <code>JsonPolicy\Manager</code> is the main and ideally the only class that you should work with.</p> <p>The main objective for the policy manager is to pre-parse the collection of policies and prepare a response to the methods like <code>isDenied</code>, <code>isAllowedTo</code> or <code>getParam</code> while taking into consideration all the defined conditions.</p> <blockquote><p><strong>FYI!</strong> By default the framework supports &quot;allow&quot; and &quot;deny&quot; <a href="/overview/policy-statement.html#effect">effects</a> that can be evaluated by isAllowed, isAllowedTo, isDenied and isDeniedTo methods. However, you can define your custom effects with <a href="/php-library/policy-manager.html#custom-effects">custom_effects</a> option.</p></blockquote> <h2 id="is"><a href="#is" class="header-anchor">#</a> -&gt;is...()</h2> <p>In order to check if any given resource or combination of resource/action can be invoked, the framework offers distinct methods with two overloads each:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// Check given resource</span>
is<span class="token operator">&lt;</span>Adjective<span class="token operator">&gt;</span><span class="token punctuation">(</span>mixed <span class="token variable">$resource</span><span class="token punctuation">,</span> mixed <span class="token variable">$args</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span> bool<span class="token operator">|</span><span class="token constant">null</span>
is<span class="token operator">&lt;</span>Adjective<span class="token operator">&gt;</span><span class="token punctuation">(</span>mixed <span class="token variable">$resource</span><span class="token punctuation">,</span> bool <span class="token variable">$default</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">,</span> mixed <span class="token variable">$args</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span> bool

<span class="token comment">// Check given resource and action</span>
is<span class="token operator">&lt;</span>Adjective<span class="token operator">&gt;</span><span class="token function">To</span><span class="token punctuation">(</span>mixed <span class="token variable">$resource</span><span class="token punctuation">,</span> string <span class="token variable">$action</span><span class="token punctuation">,</span> mixed <span class="token variable">$args</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span> bool<span class="token operator">|</span><span class="token constant">null</span>
is<span class="token operator">&lt;</span>Adjective<span class="token operator">&gt;</span><span class="token function">To</span><span class="token punctuation">(</span>mixed <span class="token variable">$resource</span><span class="token punctuation">,</span> string <span class="token variable">$action</span><span class="token punctuation">,</span> bool <span class="token variable">$default</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">,</span> mixed <span class="token variable">$args</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span> bool
</code></pre></div><h3 id="parameters"><a href="#parameters" class="header-anchor">#</a> Parameters</h3> <p><strong>$resource</strong><br>
The resource that is evaluated. It can be anything as long as you have a way to convert it to a string name. If the resource is an object, by default, the framework converts it to class name with <a href="https://www.php.net/manual/en/function.get-class" target="_blank" rel="noopener noreferrer">get_class<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> PHP function. You can register custom interpreters with the <a href="/php-library/policy-manager.html#custom-resources">custom_resources</a> setting.</p> <p><strong>$action</strong><br>
A string value for the action that can be performed upon the resource.</p> <p><strong>$default</strong><br>
An optional boolean value that is returned if no applicable statements are found. The applicable statement is the one that targets provided resource and conditions are evaluated to <code>true</code>.</p> <p><strong>$args</strong><br>
The optional parameter that contains a non-boolean value that is added to the context and can be referred to in a policy with <code>${ARGS.&lt;path&gt;}</code> marker.
</p><hr><p></p> <p>The only difference between <code>is&lt;Adjective&gt;</code> and <code>is&lt;AdjectiveTo&gt;</code> is that the second method expects the second argument to be a string value for the action.</p> <blockquote><p><strong>Note!</strong> Please don't get this verbosity to confuse you. The only reason all this exists is to give you the ability to be more granular with policies. Not everything is only &quot;allow&quot; and &quot;deny&quot;. Sometimes it is more intuitive to use <a href="/overview/policy-statement.html#effect">effects</a> like &quot;restrict&quot;, &quot;attach&quot;, &quot;apply&quot;, etc.</p></blockquote> <p>In the example below, we check if a specific page is restricted based on the policy.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$manager</span> <span class="token operator">=</span> PolicyManager<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$page</span>    <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PageEntity</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token single-quoted-string string">'id'</span>   <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">123</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'slug'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'some-page'</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'cats'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
        <span class="token single-quoted-string string">'restricted'</span><span class="token punctuation">,</span>
        <span class="token single-quoted-string string">'science'</span>
    <span class="token punctuation">]</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$manager</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isRestrictedTo</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'view'</span><span class="token punctuation">,</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token single-quoted-string string">'Yes you are allowed to view this page'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;Statement&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;Effect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;restrict&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;Resource&quot;</span><span class="token operator">:</span> <span class="token string">&quot;PageEntity&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;Action&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">&quot;view&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;edit&quot;</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;Condition&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;In&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;restricted&quot;</span><span class="token operator">:</span> <span class="token string">&quot;(*array)${PageEntity.cats}&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="getparam"><a href="#getparam" class="header-anchor">#</a> -&gt;getParam()</h2> <p>Get applicable param from the defined policies.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token function">getParam</span><span class="token punctuation">(</span>string <span class="token variable">$key</span><span class="token punctuation">,</span> mixed <span class="token variable">$default</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">,</span> mixed <span class="token variable">$args</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span> mixed
</code></pre></div><h3 id="parameters-2"><a href="#parameters-2" class="header-anchor">#</a> Parameters</h3> <p><strong>$key</strong><br>
A string value for the param's <a href="/overview/policy-param.html#key">Key</a>.</p> <p><strong>$default</strong><br>
The optional default value is returned if no applicable params are found. By default, the <code>null</code> value is returned.</p> <p><strong>$args</strong><br>
The optional parameter that value is going to be added to the context and can be referred to in a policy with <code>${ARGS.&lt;path&gt;}</code> marker.
</p><hr><p></p> <p>In the example below, we determine the proper API endpoint based on the environment variable <code>APP_ENV</code>.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">use</span> <span class="token package">JsonPolicy<span class="token punctuation">\</span>Manager</span><span class="token punctuation">;</span>

<span class="token variable">$manager</span> <span class="token operator">=</span> Manager<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token single-quoted-string string">'policies'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
        <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token constant">__DIR__</span>  <span class="token punctuation">.</span> <span class="token single-quoted-string string">'/policy.json'</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$manager</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getParam</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'API:endpoint'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;Param&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;Key&quot;</span><span class="token operator">:</span> <span class="token string">&quot;API:endpoint&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;Value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://staging-myapi.mydomain.io&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;Condition&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;Equals&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;(*int)${ENV.APP_ENV}&quot;</span><span class="token operator">:</span> <span class="token string">&quot;staging&quot;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;Key&quot;</span><span class="token operator">:</span> <span class="token string">&quot;API:endpoint&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;Value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://myapi.mydomain.io&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;Condition&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;Equals&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;(*int)${ENV.APP_ENV}&quot;</span><span class="token operator">:</span> <span class="token string">&quot;production&quot;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="bootstrap"><a href="#bootstrap" class="header-anchor">#</a> ::bootstrap()</h2> <p>Bootstrap the policy manager instance. Multiple independent instances can be instantiated with different settings and used either in global or local application scopes.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token keyword">array</span> <span class="token variable">$settings</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span> JsonPolicy\<span class="token package">Manager</span>
</code></pre></div><h3 id="parameters-3"><a href="#parameters-3" class="header-anchor">#</a> Parameters</h3> <p><strong>$settings</strong><br>
The array of various settings that configure the policy manager's behavior. More detail about each supported setting below.
</p><hr><p></p> <p>The <code>bootstrap</code> method accepts an optional associated array of settings where each value can be either array or <code>Closure</code> that returns an array. Below is the list of all recognizable settings.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">use</span> <span class="token package">JsonPolicy<span class="token punctuation">\</span>Manager</span> <span class="token keyword">as</span> PolicyManager<span class="token punctuation">;</span>

<span class="token variable">$manager</span> <span class="token operator">=</span> PolicyManager<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token single-quoted-string string">'context'</span>           <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'custom_markers'</span>    <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'custom_types'</span>      <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'custom_conditions'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'custom_resources'</span>  <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'custom_effects'</span>    <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'policies'</span>          <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="context"><a href="#context" class="header-anchor">#</a> context</h2> <ul><li>Type: <code>Array|Object|Closure</code></li></ul> <p>The context may contain any type of data as long as it is organized as a traversable value or <code>Closure</code> that returns a traversable value. The context is passed alone to parsers and used typically during <a href="/overview/policy-marker.html">markers</a> evaluation.</p> <p>For example, in the sample below, we pass in the context some information about the current user and in our policies, we refer to this information through the <code>${ARGS.&lt;xpath&gt;}</code> marker.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$manager</span> <span class="token operator">=</span> PolicyManager<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token single-quoted-string string">'context'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
        <span class="token single-quoted-string string">'args'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
            <span class="token single-quoted-string string">'user'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
                <span class="token single-quoted-string string">'id'</span>       <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token single-quoted-string string">'location'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
                    <span class="token single-quoted-string string">'city'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'New York'</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The policy below defines conditional param that is applicable only if the user's <code>id</code> equals <code>1</code> or the user's city is whitelisted.</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;Param&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;Key&quot;</span><span class="token operator">:</span> <span class="token string">&quot;allow-upgrade&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;Value&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token property">&quot;Condition&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;Operator&quot;</span><span class="token operator">:</span> <span class="token string">&quot;OR&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;Equals&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;(*int)${ARGS.user.id}&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;In&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;${ARGS.user.location.city}&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                    <span class="token string">&quot;New York&quot;</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;Paris&quot;</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Finally in the code, the <code>allow-upgrade</code> flag can be fetched easily without bothering about any conditional logic.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$manager</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getParam</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'allow-upgrade'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token single-quoted-string string">'You can do upgrade'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="custom-markers"><a href="#custom-markers" class="header-anchor">#</a> custom_markers</h2> <ul><li>Type: <code>Array|Closure</code></li></ul> <p>By default, the framework supports only a <a href="/php-library/policy-marker.html">few markers</a>, however, it can be easily extended to an unlimited number of custom markers.</p> <p>The <code>custom_markers</code> should be resolved to the associated array of key/value pairs where the key is a case-sensitive marker and value is the valid <a href="https://www.php.net/manual/en/language.types.callable.php" target="_blank" rel="noopener noreferrer">callback<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>The defined callback accepts two arguments and may return any value.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token function">callback_function</span><span class="token punctuation">(</span>string <span class="token variable">$path_to_property</span><span class="token punctuation">,</span> JsonPolicy\<span class="token package">Core<span class="token punctuation">\</span>Context</span> <span class="token variable">$context</span><span class="token punctuation">)</span><span class="token punctuation">:</span> mixed
</code></pre></div><p>In the sample below, we define a custom marker <code>USER</code> that tries to get current user property</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">use</span> <span class="token package">JsonPolicy<span class="token punctuation">\</span>Core<span class="token punctuation">\</span>Context</span><span class="token punctuation">;</span>

<span class="token variable">$manager</span> <span class="token operator">=</span> PolicyManager<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token single-quoted-string string">'custom_markers'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
        <span class="token single-quoted-string string">'USER'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$prop</span><span class="token punctuation">,</span> Context <span class="token variable">$context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> MyApp<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">getCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token variable">$prop</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>In the policy, you can refer to the current user instance with <code>${USER.&lt;prop&gt;}</code> marker.</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;Statement&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;Effect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;deny&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;Resource&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Coupon&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;Condition&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;Equals&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;${USER.full_name}&quot;</span><span class="token operator">:</span> <span class="token string">&quot;John Smith&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="custom-types"><a href="#custom-types" class="header-anchor">#</a> custom_types</h2> <ul><li>Type: <code>Array|Closure</code></li></ul> <p>The policy <a href="/policy-marker.html#type-casting">typecasting</a> is critical to cast raw values to the type that is most suited for a statement or param. The framework covers widely used types of data, however, sometimes it is useful to convert values into a custom format.</p> <p>The <code>custom_types</code> should be resolved to the associated array of key/value pairs where the key is a case-sensitive type name and value is a valid <a href="https://www.php.net/manual/en/language.types.callable.php" target="_blank" rel="noopener noreferrer">callback<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>The defined callback accepts one argument and may return any value.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token function">callback_function</span><span class="token punctuation">(</span>mixed <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">:</span> mixed
</code></pre></div><p>In the example below, we define a custom typecast <code>md5</code> that creates an MD5 hash from a given value and this is used in the condition later.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">use</span> <span class="token package">JsonPolicy<span class="token punctuation">\</span>Core<span class="token punctuation">\</span>Context</span><span class="token punctuation">;</span>

<span class="token variable">$manager</span> <span class="token operator">=</span> PolicyManager<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token single-quoted-string string">'custom_types'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
        <span class="token single-quoted-string string">'md5'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;Statement&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;Effect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;allow&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;Resource&quot;</span><span class="token operator">:</span> <span class="token string">&quot;File&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;Action&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">&quot;update&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;rename&quot;</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;Condition&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;Equals&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;(*md5)${ARGS.token}&quot;</span><span class="token operator">:</span> <span class="token string">&quot;098f6bcd4621d373cade4e832627b4f6&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$manager</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isAllowedTo</span><span class="token punctuation">(</span><span class="token variable">$fileObject</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'update'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token single-quoted-string string">'token'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'U893L0'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Do something here</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="custom-conditions"><a href="#custom-conditions" class="header-anchor">#</a> custom_conditions</h2> <ul><li>Type: <code>Array|Closure</code></li></ul> <p>Provide a collection of custom types of <a href="/overview/policy-condition.html">conditions</a> that either declare new types of conditions.</p> <p>The <code>custom_conditions</code> should be resolved to the associated array of key/value pairs where the key is a case-sensitive type name and value is a valid <a href="https://www.php.net/manual/en/language.types.callable.php" target="_blank" rel="noopener noreferrer">callback<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>The defined callback accepts three arguments and has to return a single boolean value.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token function">callback_function</span><span class="token punctuation">(</span><span class="token keyword">array</span> <span class="token variable">$group</span><span class="token punctuation">,</span> string <span class="token variable">$operator</span><span class="token punctuation">,</span> ConditionManager <span class="token variable">$manager</span><span class="token punctuation">)</span><span class="token punctuation">:</span> boolean
</code></pre></div><p>In the example below, we declare a new condition <code>Similar</code> that checks if two strings are similar. The two strings are considered to be similar if they are more than 60% similar. This way we prevent a user from publishing content if it is at least 60% similar to one of the articles from the collection of articles.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// Instantiating policy manager</span>
<span class="token variable">$manager</span> <span class="token operator">=</span> PolicyManager<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token single-quoted-string string">'custom_conditions'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
        <span class="token single-quoted-string string">'Similar'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$group</span><span class="token punctuation">,</span> <span class="token variable">$operator</span><span class="token punctuation">,</span> <span class="token variable">$manager</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>

            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$group</span> <span class="token keyword">as</span> <span class="token variable">$cnd</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$sub_result</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>

                <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$cnd</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'right'</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token variable">$sim</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token function">similar_text</span><span class="token punctuation">(</span><span class="token variable">$cnd</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'left'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">,</span> <span class="token variable">$sim</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token variable">$sub_result</span> <span class="token operator">=</span> <span class="token variable">$manager</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token variable">$sub_result</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token variable">$sim</span> <span class="token operator">&gt;</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'OR'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$manager</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">,</span> <span class="token variable">$sub_result</span><span class="token punctuation">,</span> <span class="token variable">$operator</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'policies'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// This is the article that user is trying to publish</span>
<span class="token variable">$article</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Article</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token single-quoted-string string">'content'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'...'</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'title'</span>   <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'My original article'</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Fetching raw array of articles' content from some data source</span>
<span class="token variable">$articles</span> <span class="token operator">=</span> MyAPI<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">fetchArticles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$manager</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isAllowedTo</span><span class="token punctuation">(</span><span class="token variable">$article</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'publish'</span><span class="token punctuation">,</span> <span class="token boolean constant">true</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token single-quoted-string string">'articles'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$articles</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token single-quoted-string string">'Yes. Your article is actually original'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token single-quoted-string string">'Ooops. Looks like your article is quite similar to some other article'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;Statement&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;Effect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;deny&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;Resource&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Article&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;Action&quot;</span><span class="token operator">:</span> <span class="token string">&quot;publish&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;Condition&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;Similar&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;${Article.content}&quot;</span><span class="token operator">:</span> <span class="token string">&quot;(*array)${ARGS.articles}&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="custom-resources"><a href="#custom-resources" class="header-anchor">#</a> custom_resources</h2> <ul><li>Type: <code>Array|Closure</code></li></ul> <p>The <a href="/php-library/policy-manager.html#is">-&gt;is..()</a> methods expect the first argument to be a resource that is evaluated. The resource can be either an object that is converted to a string or a simple string value that is taken as-is. In the first case, by default, the object's class name is used and this is not always ideal. That is why you can declare a custom callback that takes the evaluating resource and convert it into a string alias.</p> <p>It is important to identify the resource's alias so it can be matched with the name defined in a statement's <a href="/overview/policy-statement.html#resource">Resource</a> attribute.</p> <p>The callback accepts three arguments and has to return a scalar value or <code>null</code> if the provided resource does not match an expected value.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token function">callback_function</span><span class="token punctuation">(</span>mixed <span class="token variable">$name</span><span class="token punctuation">,</span> mixed <span class="token variable">$resource</span><span class="token punctuation">,</span> Manager <span class="token variable">$manager</span><span class="token punctuation">)</span><span class="token punctuation">:</span> mixed
</code></pre></div><p>In many cases, the resource's alias has to be computed dynamically based on its properties. For example, let's say you have a page object that is identified by the unique ID and some unique slug. This way you can prepare a policy that targets a very specific page and define a custom callback that converts the page object to its resource alias.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// Instantiating policy manager</span>
<span class="token variable">$manager</span> <span class="token operator">=</span> PolicyManager<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token single-quoted-string string">'custom_resources'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
        <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token variable">$resource</span><span class="token punctuation">,</span> <span class="token variable">$manager</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// It is a good practice to check if $name is still empty and provided</span>
            <span class="token comment">// resource matches expected class name. This way you do not override</span>
            <span class="token comment">// name if was already set by some other custom_resource callback</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_a</span><span class="token punctuation">(</span><span class="token variable">$resource</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'Page'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;Page:<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$resource</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">slug</span><span class="token punctuation">}</span></span>&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> <span class="token variable">$name</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'policies'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$page</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token single-quoted-string string">'ID'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">124</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'slug'</span>   <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'private-portal'</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$manager</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isAllowed</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">,</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token single-quoted-string string">'Yes. You can access this page'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token single-quoted-string string">'No. You cannot access this page'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;Statement&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;Effect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;deny&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;Resource&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Page:private-portal&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="custom-effects"><a href="#custom-effects" class="header-anchor">#</a> custom_effects</h2> <ul><li>Type: <code>Array|Closure</code></li></ul> <p>To improve policy readability it is not always intuitive to use only &quot;allow&quot; and &quot;deny&quot; <a href="/overview/policy-statement.html#effect">effects</a>. Sometime you might want to use verbs like &quot;apply&quot;, &quot;restrict&quot; or &quot;hide&quot;. Then you can be more verbose in your code by using methods like <code>isApplied</code>, <code>isRestricted</code>, or <code>isHidden</code>.</p> <p>To define custom effects, simply provide an associated array of key/value pairs or an anonymous function that returns such array. It is recommended for keys to use adjectives and values have to match <a href="/overview/policy-statement.html#effect">effects</a> that are used in policies.</p> <p>For example, below we build a simple application for boy scouts, were based on logged-in member, we determine what badges are attached to him.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$manager</span> <span class="token operator">=</span> PolicyManager<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token single-quoted-string string">'policies'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'custom_effects'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
        <span class="token single-quoted-string string">'attached'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'attach'</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$member</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Member</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token single-quoted-string string">'name'</span>   <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'John Smith'</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'groups'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
        <span class="token single-quoted-string string">'advanced'</span><span class="token punctuation">,</span>
        <span class="token single-quoted-string string">'rock-climber'</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$badges</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token single-quoted-string string">'super-badge'</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'advanced-badge'</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'smart-badge'</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$badges</span> <span class="token keyword">as</span> <span class="token variable">$badge</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$manager</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isAttached</span><span class="token punctuation">(</span><span class="token variable">$badge</span><span class="token punctuation">,</span> <span class="token boolean constant">false</span><span class="token punctuation">,</span> <span class="token variable">$member</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;The <span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$badge</span><span class="token punctuation">}</span></span> is attached\n&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;The <span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$badge</span><span class="token punctuation">}</span></span> is not attached\n&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;Statement&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;Effect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;attach&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;Resource&quot;</span><span class="token operator">:</span> <span class="token string">&quot;super-badge&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;Condition&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;In&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;superstar&quot;</span><span class="token operator">:</span> <span class="token string">&quot;(*array)${ARGS.groups}&quot;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;Effect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;attach&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;Resource&quot;</span><span class="token operator">:</span> <span class="token string">&quot;advanced-badge&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;Condition&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;In&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;advanced&quot;</span><span class="token operator">:</span> <span class="token string">&quot;(*array)${ARGS.groups}&quot;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;Effect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;attach&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;Resource&quot;</span><span class="token operator">:</span> <span class="token string">&quot;smart-badge&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;Condition&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;In&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">&quot;smart&quot;</span><span class="token operator">:</span> <span class="token string">&quot;(*array)${ARGS.groups}&quot;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="policies"><a href="#policies" class="header-anchor">#</a> policies</h2> <ul><li>Type: <code>Array|Closure</code></li></ul> <p>Array or <code>Closure</code> that returns the array of JSON policies. It is outside of the framework's scope to determine a list of policies that should be attached to the current user or process. When you instantiate the JSON policy manager, the list of policies should be already defined.</p> <p>It is also outside of the framework's scope to determine where policies are stored. They can be part of the project or located on the remote server. In the example below, we fetch a policy from the public Github repository.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$manager</span> <span class="token operator">=</span> PolicyManager<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token single-quoted-string string">'policies'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>
            <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'https://raw.githubusercontent.com/jsonpolicy/jsonpolicy-php/master/samples/remote-policy-repository/policy.json'</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$manager</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isAllowed</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'registration'</span><span class="token punctuation">,</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;The registration is available\n&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;Registration endpoint is &quot;</span> <span class="token punctuation">.</span> <span class="token variable">$manager</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getParam</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'registration-endpoint'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token single-quoted-string string">'No, the registration is disabled'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;Statement&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;Effect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;allow&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;Resource&quot;</span><span class="token operator">:</span> <span class="token string">&quot;registration&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;Param&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;Key&quot;</span><span class="token operator">:</span> <span class="token string">&quot;registration-endpoint&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;Value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://myappdomain.io/register&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The example may explain why the framework is described as a distributed rule engine because you can define a centralized location for policies and distribute them across multiple applications disregarding if they use the same programming language or not.</p> <p>The example also shows how you can design a simple <a href="https://en.wikipedia.org/wiki/Feature_toggle" target="_blank" rel="noopener noreferrer">feature flag<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> system or distributed configurations engine. The policy <a href="/overview/policy-param.html#key">params</a> are great candidates for this.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/php-library/" class="prev router-link-active">
        Introduction
      </a></span> <span class="next"><a href="/php-library/policy-marker.html">
        Policy Markers
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.c4123b23.js" defer></script><script src="/assets/js/2.d3ea8322.js" defer></script><script src="/assets/js/16.bf02c3a1.js" defer></script>
  </body>
</html>
